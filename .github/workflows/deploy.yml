name: Deploy API to Raspberry

on:
  push:
    branches:
      - main

jobs:
  test-deploy:
    runs-on: [self-hosted]
    env:
      APP_PATH: /srv/{{ PATH }}/appdata

    steps:
      - name: Mostrar hostname y fecha (debug)
        run: |
          echo "ğŸ–¥ï¸ Corriendo en: $(hostname)"
          echo "ğŸ“… Fecha: $(date)"

      - name: Navegar al repo y actualizar
        run: |
          set -e
          cd $APP_PATH/libreria-mariela-api
          echo "ğŸ“¥ Haciendo pull del repo..."
          git pull origin main

      - name: Ir al folder de docker-compose y hacer deploy
        run: |
          cd $APP_PATH/libreria_mariela_docker_compose
          
          echo "ğŸ§¼ Apagando contenedores..."
          docker compose -f libreria_mariela_docker_compose.yml --env-file libreria_mariela_docker_compose.env down

          echo "ğŸ“¦ Descargando imÃ¡genes..."
          docker compose -f libreria_mariela_docker_compose.yml --env-file libreria_mariela_docker_compose.env pull

          echo "ğŸš€ Levantando contenedores..."
          if docker compose -f libreria_mariela_docker_compose.yml --env-file libreria_mariela_docker_compose.env up -d --build; then
              echo "âœ… Â¡Deploy exitoso!"
          else
              echo "âŒ FallÃ³ el build. Rollback manual necesario o revisar el build log."
              exit 1
          fi
